name: Deploy to VPS

on:
  push:
    branches: [ "main" ] # 监听 main 分支的推送

env:
  # 镜像名必须全小写！
  # 格式: ghcr.io/用户名/项目名:标签
  IMAGE_NAME: ghcr.io/usagisean/aigeneratorapi:latest

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_NAME }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 41870
          script: |
            # 1. 登录 GitHub 镜像仓库
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # 2. 停止并删除旧容器 (如果存在)
            echo "Stopping old container..."
            docker stop ai-api || true
            docker rm ai-api || true

            # 3. 拉取最新镜像
            echo "Pulling new image..."
            docker pull ${{ env.IMAGE_NAME }}

            # 4. 准备 GCP 密钥文件 (从 Secret 生成)
            mkdir -p /app
            echo '${{ secrets.GCP_JSON }}' > /app/gcp-key.json
            chmod 600 /app/gcp-key.json

            # 5. 启动新容器
            echo "Starting new container..."
            docker run -d \
              --name ai-api \
              --restart always \
              -p 6677:8080 \
              -v /app/gcp-key.json:/app/gcp-key.json \
              -e IP_WHITELIST="*" \
              -e MY_API_KEY="${{ secrets.MY_API_KEY }}" \
              -e AIConfig__Gemini__ProjectId="${{ secrets.GCP_PROJECT_ID }}" \
              -e AIConfig__Gemini__Location="us-central1" \
              -e AIConfig__Gemini__KeyFilePath="/app/gcp-key.json" \
              -e AIConfig__Gemini__ProxyUrl="" \
              -e AIConfig__NewApi__BaseUrl="${{ secrets.NEW_API_BASE }}" \
              -e AIConfig__NewApi__FreeApiKey="${{ secrets.NEW_API_FREE }}" \
              -e AIConfig__NewApi__VipApiKey="${{ secrets.NEW_API_VIP }}" \
              ${{ env.IMAGE_NAME }}

            # 6. 清理旧镜像
            docker image prune -f
